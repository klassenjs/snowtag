<!DOCTYPE html>
<html>
<head>
    <title>Map Replay</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">
    <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
    <div id="mapreplay-map"></div>

    <div id="mapreplay-options" style="display: none;">
        <form class="pure-form pure-form-stacked">
            <fieldset>
                <div class="pure-g">
                    <select id="mapreplay-options-vehicle" class="pure-u-1-1"></select>
                </div>
            </fieldset>
        </form>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
    <script type="text/javascript">
        geotab.addin.mapreplay = function(api, state) {
            var map;

            var vehicles;

            var initializeMap = function () {
                // Initialize the map container

								map = new L.Map("mapreplay-map").on("load", function () {
										setTimeout(function () {
												map.invalidateSize();
										}, 500);
									}).setView([44.94, -93.10], 13);

										// Add the map tiles layer

										L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
												subdomains: "abc",
												type: "osm",
												attribution: "&copy; <a href=\"http://osm.org/copyright\">OpenStreetMap</a> contributors",
												id: 'mapbox.streets',
												maxZoom: 18
										}).addTo(map);
								};

            var getVehicles = function (finishedCallback) {
                api.call("Get", {
                    typeName: "Device"
                }, function (results) {
                    vehicles = results.map(function (vehicle) {
                        return {
                            name: vehicle.name,
                            id: vehicle.id
                        };
                    });
                    finishedCallback();
                }, function (errorString) {
                    alert(errorString);
                });
            };

            var populateVehicleSelect = function () {
                var vehicleSelect = document.getElementById("mapreplay-options-vehicle");
                vehicleSelect.appendChild((function () {
                    var defaultOption = document.createElement("option");
                    defaultOption.default = true;
                    defaultOption.selected = true;
                    defaultOption.value = "";
                    defaultOption.textContent = "Select a vehicle...";
                    return defaultOption;
                })());
                if (vehicles) {
                    vehicles.forEach(function (vehicle) {
                        var opt = document.createElement("option");
                        opt.value = vehicle.id;
                        opt.textContent = vehicle.name;
                        vehicleSelect.appendChild(opt);
                    });
                }
            };

            return {
                /*
                 * Page lifecycle method: initialize is called once when the addin first starts
                 * Use this function to initialize the addin's state such as default values or
                 * make API requests (Geotab or external) to ensure interface is ready for the user.
                 */
                initialize: function(api, state, callback) {
                    // Initialize the map
                    initializeMap();

                    // Must be called to let the app know that we've initialized the addon
                    getVehicles(callback);
                },

                /*
                 * Page lifecycle method: focus is called when the page has finished initialize method
                 * and again when a user leaves and returns to your addin that has already been initialized.
                 * Use this function to refresh state such as vehicles, zones or exceptions which may have
                 * been modified since it was first initialized.
                 */
                focus: function() {
                    populateVehicleSelect();
                },

                /*
                 * Page lifecycle method: blur is called when the user is leaving your addin.
                 * Use this function to save state or commit changes to a datastore or release memory.
                 */
                blur: function() {
                }
            };
        };
    </script>
</body>
</html>


<!-- <!DOCTYPE html>
<html>
<head>
    <title>Map Replay</title>
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
	    integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
	    crossorigin=""/>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.1/pure.css">
    <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
    <div id="mapreplay-map"></div>
		<div id="mapreplay-options" style="display: none;">
        <form class="pure-form pure-form-stacked">
            <fieldset>
                <div class="pure-g">
                    <select id="mapreplay-options-vehicle" class="pure-u-1-1"></select>
                </div>
            </fieldset>
        </form>
    </div>
	<script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
	integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
	crossorigin=""></script>

	<script type="text/javascript">
	geotab.addin.mapreplay = function(api, state) {
			var map;
			var vehicles;

			var initializeMap = function () {
					// Initialize the map container

					map = new L.Map("mapreplay-map").on("load", function () {
							setTimeout(function () {
									map.invalidateSize();
							}, 500);
							document.getElementById("mapreplay-options").style.display = "block";
						}).setView([44.94, -93.10], 13);

							// Add the map tiles layer

							L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
									subdomains: "abc",
									type: "osm",
									attribution: "&copy; <a href=\"http://osm.org/copyright\">OpenStreetMap</a> contributors",
									id: 'mapbox.streets',
									maxZoom: 18
							}).addTo(map);
					};

          //Get snowtagging vehicles only
					var getVehicles = function(finishedCallback) {
						api.call('Get', {'typeName': 'Device',
			               'search': {
			                   'groups': [{'id': 'b278A'}]
			               }
									 }, function(results) {
											 vehicles = results.map(function (vehicle) {
												 return {
													 name: vehicle.name,
													 id: vehicle.id
												 };
											 });
											 finishedCallback();
										 }, function (errorString) {
											     alert(errorString);
										 });
					};

					var populateVehicleSelect = function () {
							var vehicleSelect = document.getElementById("mapreplay-options-vehicle");
							vehicleSelect.appendChild((function () {
									var defaultOption = document.createElement("option");
									defaultOption.default = true;
									defaultOption.selected = true;
									defaultOption.value = "";
									defaultOption.textContent = "Select a vehicle...";
									return defaultOption;
							})());
							if (vehicles) {
									vehicles.forEach(function (vehicle) {
											var opt = document.createElement("option");
											opt.value = vehicle.id;
											opt.textContent = vehicle.name;
											vehicleSelect.appendChild(opt);
									});
							}
					};

					return {
							/*
							 * Page lifecycle method: initialize is called once when the addin first starts
							 * Use this function to initialize the addin's state such as default values or
							 * make API requests (Geotab or external) to ensure interface is ready for the user.
							 */
							initialize: function(api, state, callback) {
									// Initialize the map
									initializeMap();

									// Must be called to let the app know that we've initialized the addon
									getVehicles(callback);
							},

							/*
							 * Page lifecycle method: focus is called when the page has finished initialize method
							 * and again when a user leaves and returns to your addin that has already been initialized.
							 * Use this function to refresh state such as vehicles, zones or exceptions which may have
							 * been modified since it was first initialized.
							 */
							focus: function() {
									populateVehicleSelect();
							},

							/*
							 * Page lifecycle method: blur is called when the user is leaving your addin.
							 * Use this function to save state or commit changes to a datastore or release memory.
							 */
							blur: function() {
							}
					};
			};
	</script>
</body>
</html> -->
